// @flow

import attrs from './attrs'
import { dim, halfPixel } from './spatial'
import setupStore from './store'
import setupFilters from './filters'
import setupMinimap from './minimap'
import setupProteins from './proteins'
import { setupMutations, updateMutations } from './mutations'
import { setupStats, updateStats } from './stats'
import setupTicks from './ticks'
import setupZoomHandlers from './zoom'
import theme from './theme'
import groupByType from './groupByType'
import animator from './animator'

/*----------------------------------------------------------------------------*/

type TProteinLolliplotArgs = {
  d3: Object,
  onMutationClick?: Function,
  onMutationMouseover?: Function,
  onMutationMouseout?: Function,
  onProteinMouseover?: Function,
  onProteinMouseout?: Function,
  data: Object,
  selector: string,
  element: Object,
  height?: number,
  width?: number,
  domainWidth?: number,
  hideStats?: bool,
  selectedMutationClass?: string,
  mutationId?: string,
  yAxisOffset?: number,
  xAxisOffset?: number,
  proteinHeight?: number,
  numXTicks?: number,
  numYTicks?: number,
  proteinDb?: string,
  store?: Object,
  onInit?: Function,
}
type TProteinLolliplot = (args: TProteinLolliplotArgs) => Object
let proteinLolliplot: TProteinLolliplot = ({
  d3,
  onMutationClick = () => {},
  onMutationMouseover = () => {},
  onMutationMouseout = () => {},
  onProteinMouseover = () => {},
  onProteinMouseout = () => {},
  data,
  selector,
  element,
  height,
  width,
  domainWidth = 500,
  hideStats = false,
  selectedMutationClass = `Consequence`,
  mutationId,
  yAxisOffset = 45,
  xAxisOffset = 200,
  store = setupStore({ domainWidth }),
  proteinHeight = 40,
  numXTicks = 12,
  numYTicks = 15,
  proteinDb = `pfam`,
  onInit = () => {},
} = {}) => {

  if (!d3) `You must pass in the d3 library, either v3 || v4`

  d3.selection.prototype.attrs = attrs
  d3.scaleOrdinal = d3.scaleOrdinal || d3.scale.ordinal
  d3.scaleLinear = d3.scaleLinear || d3.scale.linear

  // Similar to a React target element
  let root = element || document.querySelector(selector)

  if (!root) throw `Must provide an element or selector!`

  width = width || root.clientWidth
  height = height || root.clientHeight

  let statsBoxWidth = hideStats ? 0 : 250

  let xAxisLength = width - yAxisOffset - statsBoxWidth
  let scale = xAxisLength / domainWidth

  let consequences = groupByType(`consequence`, data.mutations)
  let impacts = groupByType(`impact`, data.mutations)

  let colorScale = d3.schemeCategory20
    ? d3.scaleOrdinal(d3.schemeCategory20).domain(d3.range(20))
    : d3.scale.category20().domain(d3.range(20))

  let consequenceColors = Object.keys(consequences).reduce((acc, type, i) => ({
    ...acc,
    [type]: colorScale(i * 3),
  }), {})

  let maxDonors = Math.max(...data.mutations.map(x => x.donors))

  let scaleLinearY = d3.scaleLinear()
    .domain([0, Math.round(maxDonors + 5)])
    .range([height - xAxisOffset, 0])

  // Main Chart

  let svg = d3
    .select(root)
    .append(`svg`)
    .attrs({
      class: `chart`,
      ...dim(width, height),
    })

  let defs = svg.append(`defs`)

  setupFilters(defs)

  // Chart clipPath

  defs
    .append(`clipPath`)
    .attr(`id`, `chart-clip`)
    .append(`rect`)
    .attrs({
      x: yAxisOffset,
      y: 0,
      ...dim(xAxisLength, height - xAxisOffset + proteinHeight),
    })

  // Chart zoom area

  d3.select(`.chart`)
    .append(`rect`)
    .attrs({
      class: `chart-zoom-area`,
      x: yAxisOffset,
      y: halfPixel,
      ...dim(xAxisLength, height - xAxisOffset + proteinHeight - halfPixel),
      fill: `white`,
      stroke: `rgb(181, 181, 181)`,
      'stroke-width': 1,
    })

  // yAxis

  svg
    .append(`g`)
    .append(`line`)
    .attrs({
      class: `yAxis`,
      x1: yAxisOffset,
      y1: 0,
      x2: yAxisOffset,
      y2: height - xAxisOffset + proteinHeight,
      stroke: theme.black,
    })

  // yAxis label

  d3.select(`.chart`)
    .append(`text`)
    .text(`# of Cases`)
    .attrs({
      x: 5,
      y: (height - xAxisOffset) / 2,
      'font-size': `11px`,
      transform: `rotate(270, 10, 124)`,
    })

  // xAxis

  svg
    .append(`g`)
    .append(`line`)
    .attrs({
      class: `xAxis`,
      x1: yAxisOffset,
      y1: height - xAxisOffset,
      x2: width - statsBoxWidth,
      y2: height - xAxisOffset,
      stroke: theme.black,
    })

  // Vertical line on the right of the protein bar

  svg
    .append(`g`)
    .append(`line`)
    .attrs({
      class: `yAxisRight`,
      x1: width - statsBoxWidth,
      y1: height - xAxisOffset,
      x2: width - statsBoxWidth,
      y2: height - xAxisOffset + proteinHeight,
      stroke: theme.black,
    })

  // Horizontal line under protein bar

  svg
    .append(`g`)
    .append(`line`)
    .attrs({
      class: `xAxisBottom`,
      x1: yAxisOffset,
      y1: height - xAxisOffset + proteinHeight + halfPixel,
      x2: width - statsBoxWidth,
      y2: height - xAxisOffset + proteinHeight + halfPixel,
      stroke: theme.black,
    })

  setupMinimap({
    svg,
    width,
    height,
    yAxisOffset,
    xAxisOffset,
    xAxisLength,
    proteinHeight,
    domainWidth,
    statsBoxWidth,
  })

  d3.select(`.chart`)
    .append(`text`)
    .text(proteinDb)
    .attrs({
      x: 5,
      y: height - xAxisOffset + 25,
      'font-size': `11px`,
    })

  let { mutationChartLines, mutationChartCircles } = setupMutations({
    d3,
    consequenceColors,
    scaleLinearY,
    onMutationClick,
    onMutationMouseover,
    onMutationMouseout,
    mutationId,
    data,
    yAxisOffset,
    xAxisOffset,
    height,
    proteinHeight,
    scale,
    maxDonors,
    store,
  })

  svg
    .append(`g`)
    .append(`rect`)
    .attrs({
      class: `minimap-slide-target`,
      x: xAxisLength + yAxisOffset - 20,
      y: height - xAxisOffset + proteinHeight + 25,
      ...dim(15, 15),
      fill: `rgb(255, 255, 255)`,
      stroke: `rgb(57, 57, 57)`,
      cursor: `move`,
    })

  svg
    .append(`text`)
    .text(`âŸº`)
    .attrs({
      class: `minimap-slide-target-arrow`,
      x: xAxisLength + yAxisOffset - 19,
      y: height - xAxisOffset + proteinHeight + 36,
      'font-size': `11px`,
      'pointer-events': `none`,
    })

  let draw = animator({
    d3,
    store,
    data,
    yAxisOffset,
    xAxisOffset,
    statsBoxWidth,
    height,
    width,
    domainWidth,
    scale,
    proteinHeight,
    numXTicks,
    mutationChartLines,
    mutationChartCircles,
    consequences,
    impacts,
    consequenceColors,
  })

  let { stats } = setupStats({
    d3,
    consequenceColors,
    data,
    store,
    selector,
    hideStats,
    statsBoxWidth,
    width,
    selectedMutationClass,
    consequences,
    impacts,
    mutationChartLines,
    mutationChartCircles,
    height,
    xAxisOffset,
    root,
  })

  let reset = () => {
    store.update({
      animating: true,
      targetMin: 0,
      targetMax: domainWidth,
      consequenceFilters: [],
      impactFilters: [],
    })

    updateStats({
      d3,
      store,
      data,
      consequences,
      impacts,
      consequenceColors,
      height,
      xAxisOffset,
      mutationChartLines,
      mutationChartCircles,
    })

    updateMutations({ checked: true, data, mutationClass: null, type: null })
    draw()
  }

  let resetBtn = document.querySelector(`#reset`)
  if (resetBtn) resetBtn.addEventListener(`click`, reset)

  let { removeZoomHandlers } = setupZoomHandlers({
    store,
    yAxisOffset,
    xAxisOffset,
    xAxisLength,
    domainWidth,
    scale,
    svg,
    height,
    proteinHeight,
    draw,
  })

  setupProteins({
    d3,
    defs,
    onProteinMouseover,
    onProteinMouseout,
    data,
    store,
    scale,
    yAxisOffset,
    xAxisOffset,
    proteinHeight,
    height,
    draw,
  })

  setupTicks({
    d3,
    svg,
    numYTicks,
    numXTicks,
    maxDonors,
    scaleLinearY,
    xAxisOffset,
    yAxisOffset,
    domainWidth,
    scale,
    height,
  })

  let remove = () => {
    if (resetBtn) resetBtn.removeEventListener(`click`, reset)
    removeZoomHandlers()
    svg.remove()
    stats.remove()
  }

  draw()
  onInit()

  return {
    reset,
    updateStats,
    draw,
    remove,
    store,
  }

}

/*----------------------------------------------------------------------------*/

export default proteinLolliplot
export { setupStore }
