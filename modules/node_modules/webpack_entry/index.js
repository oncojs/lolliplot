import 'babel-polyfill'
import lolliplot, { setupStore } from '@oncojs/lolliplot'
import mockData from '@oncojs/lolliplot/data'
import * as d3 from 'd3'

let addChart = selector => {
  let domainWidth = 500
  let store = setupStore({ domainWidth })

  let root = document.querySelector(`${selector} .root`)

  // -- for testing d3@3
  // let d3 = window.d3

  let {
    reset,
    remove,
    update,
  } = lolliplot({
    element: root,
    data: mockData(120),
    onMutationClick: (d, event) => console.log(d, event),
    height: 300,
    domainWidth,
    mutationId: `MU10`,
    store,
    d3,
    animate: false,
    xAxisOffset: 140,
  })

  /*----------------------------------------------------------------------------*/

  let range = document.querySelector(`${selector} .mut-count`)
  let label = document.querySelector(`${selector} .mut-count-label`)

  let zoomMinInput = document.querySelector(`${selector} .zoom-min`)
  let zoomMaxInput = document.querySelector(`${selector} .zoom-max`)

  zoomMinInput.value = 0
  zoomMaxInput.value = domainWidth

  zoomMinInput.addEventListener(`input`, e => {
    update({
      animating: true,
      targetMin: +e.target.value,
      targetMax: store.getState().targetMax,
    })
  })

  zoomMaxInput.addEventListener(`input`, e => {
    update({
      animating: true,
      targetMin: store.getState().targetMin,
      targetMax: +e.target.value,
    })
  })

  let resetBtn = document.querySelector(`${selector} .reset`)

  resetBtn.addEventListener(`click`, reset)

  window.range = range

  range.oninput = event => {
    remove()
    label.innerText = event.target.value
    lolliplot({
      element: root,
      data: mockData(+event.target.value),
      clickHandler: d => console.dir(d),
      height: 450,
      domainWidth,
      mutationId: `MU10`,
      store,
      d3,
    })
  }

  window.addEventListener(`resize`, () => {
    remove()
    lolliplot({
      element: root,
      data: mockData(80),
      clickHandler: d => console.dir(d),
      height: 450,
      mutationId: `MU10`,
      store,
      d3,
    })
  })

  store.subscribe(() => {
    let { targetMin, targetMax, min, max } = store.getState()
    zoomMinInput.value = targetMin
    zoomMaxInput.value = targetMax

    let resetDisabled = min === 0 && max === domainWidth
    console.log(`...`, resetDisabled)
  })
}

addChart(`.container-1`)
addChart(`.container-2`)
